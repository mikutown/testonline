<!DOCTYPE html>
<!--
This is a starter template page. Use this page to start your new project from
scratch. This page gets rid of all links and provides the needed markup only.
-->
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>用户列表</title>
    <!-- Tell the browser to be responsive to screen width -->
    <meta content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" name="viewport">
    <link rel="stylesheet" href="bower_components/bootstrap/dist/css/bootstrap.min.css"
          th:href="@{/bower_components/bootstrap/dist/css/bootstrap.min.css}">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="bower_components/font-awesome/css/font-awesome.min.css"
          th:href="@{/bower_components/font-awesome/css/font-awesome.min.css}">
    <!-- Ionicons -->
    <link rel="stylesheet" href="bower_components/Ionicons/css/ionicons.min.css"
          th:href="@{/bower_components/Ionicons/css/ionicons.min.css}">
    <!-- Theme style -->
    <link rel="stylesheet" href="dist/css/AdminLTE.min.css" th:href="@{/dist/css/AdminLTE.min.css}">
    <!-- AdminLTE Skins. We have chosen the skin-blue for this starter
          page. However, you can choose any other skin. Make sure you
          apply the skin class to the body tag so the changes take effect. -->
    <link rel="stylesheet" href="dist/css/skins/skin-blue.min.css" th:href="@{/dist/css/skins/_all-skins.min.css}">
    <!-- DataTables -->
    <link rel="stylesheet" href="../../bower_components/datatables.net-bs/css/dataTables.bootstrap.min.css"
          th:href="@{/bower_components/datatables.net-bs/css/dataTables.bootstrap.min.css}">
    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <link rel="stylesheet" href="https://unpkg.com/bootstrap-table@1.15.5/dist/bootstrap-table.min.css">
    <!-- jQuery 3 -->
    <script src="bower_components/jquery/dist/jquery.min.js"
            th:src="@{/bower_components/jquery/dist/jquery.min.js}"></script>
    <!-- Bootstrap 3.3.7 -->
    <script src="bower_components/bootstrap/dist/js/bootstrap.min.js"
            th:src="@{/bower_components/bootstrap/dist/js/bootstrap.min.js}"></script>
    <!-- AdminLTE App -->
    <script src="dist/js/adminlte.min.js" th:src="@{/dist/js/adminlte.min.js}"></script>

</head>
<body class="hold-transition skin-green-light sidebar-mini">
<div class="wrapper">

    <!-- Main Header -->
    <div th:replace="~{/views/layout/header :: headerAA}"></div>
    <!-- Left side column. contains the logo and sidebar -->
    <div th:replace="~{/views/layout/menuroot :: menuroot}"></div>

    <!-- Content Wrapper. Contains page content -->
    <div class="content-wrapper">
        <!-- Content Header (Page header) -->
        <section class="content-header">
            <h1>
                用户列表
                <small>查看所有用户</small>
            </h1>
            <ol class="breadcrumb">
                <li><a href="#"><i class="fa fa-dashboard"></i> 首页</a></li>
                <li><a href="#">用户管理</a></li>
                <li class="active">用户列表</li>
            </ol>
        </section>

        <!-- Main content -->
        <section class="content">
            <div class="row">
                <div class="col-xs-12">
                    <div class="box">
                        <div class="box-header">
                            <h3 class="box-title">查看所有用户</h3>
                        </div>
                        <!-- /.box-header -->
                        <div class="box-body">
                            <div id="toolbar">
                                <!-- Button trigger modal -->
                                <button type="button" class="btn btn-primary" data-toggle="modal"
                                        data-target="#UserManageModal">
                                    <i class="fa fa-file">添加新的用户</i>
                                </button>
                                <button type="button" class="btn btn-danger" id="removeBtn">
                                    <i class="fa fa-file">删除选中用户</i>
                                </button>
                                <div class="pull-right">
                                    <input   type="text" id="keyword" placeholder="按照名称查询">
                                    <button type="button" class="btn btn-info" id="searchBtn">
                                        <i class="fa fa-search">搜索</i>
                                    </button>
                                </div>

                            </div>
                            <table id="userTable">

                            </table>
                        </div>
                        <!-- /.box-body -->
                    </div>
                    <!-- /.box -->
                </div>
                <!-- /.col -->
            </div>
            <!-- /.row -->
        </section>
        <!-- /.content -->
    </div>
    <!-- /.content-wrapper -->
    <!-- Modal -->
    <div class="modal fade" id="UserManageModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel"
         aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title">用户添加</h4>
                </div>
                <div class="modal-body">
                    <form id="userAdd">
                        <div class="form-group">
                            <label for="uname">用户名</label>
                            <input type="text" class="form-control" name="uname" id="uname" placeholder="请输入用户名" >
                        </div>
                        <div class="form-group">
                            <label for="password">密码</label>
                            <input type="password" class="form-control" id="password"
                                   placeholder="请输入密码" name="password">
                        </div>
                        <div class="form-group">
                            <label for="repassword">确认密码</label>
                            <input type="password" class="form-control" id="repassword"
                                   placeholder="请确认密码" name="repassword">
                        </div>
                        <button type="submit" class="btn btn-primary ">添加</button>
                        <button type="button" class="btn btn-default " data-dismiss="modal">关闭</button>
                    </form>
                </div>
                <div class="modal-footer">
                    <span>请在输入用户信息后点击添加按钮</span>
                </div>

            </div>
            <!-- /.modal-content -->
        </div>
        <!-- /.modal-dialog -->
    </div>
    <!-- Main Footer -->
    <div th:replace="~{/views/layout/foot :: footer}"></div>


</div>
<!-- ./wrapper -->

<!-- REQUIRED JS SCRIPTS -->
<!--bootstrap-table-js-->
<!--<script src="https://unpkg.com/bootstrap-table@1.15.5/dist/bootstrap-table-js.min.js"></script>-->
<script src="plugins/bootstrap-table/bootstrap-table.js"
        th:src="@{/bootstrap-table/bootstrap-table.js}"></script>
<script src="plugins/bootstrap-table/locale/bootstrap-table-zh-CN.js"
        th:src="@{/bootstrap-table/locale/bootstrap-table-zh-CN.js}"></script>
<script th:src="@{/layer/layer.js}"></script>
<!--注意引用顺序-->
<script th:src="@{/jquery-validation/jquery.validate.min.js}"></script>
<script th:src="@{/jquery-validation/additional-methods.min.js}"></script>
<script th:src="@{/jquery-validation/localization/messages_zh.min.js}"></script>
<!-- 页面菜单选中的配置 -->
<script>
    $(function () {
        //把所有的active都收起来
        $("li.active").removeClass("active");
        $("#usertree").addClass("active");
        $("#usermanage").addClass("active");
    })
</script>
<script>
    //删除单个用户
    function removeUser(uId) {
        layer.msg('确定删除吗？', {
            time: 0,
            btn: ['确定', '删个屁'],
            yes: function (index) {
                layer.close(index);
                $.ajax({
                    url: '/user/remove?uId=' + uId,
                    success: function (msg) {
                        var json = msg["data"];
                        if (json["success"]){
                            layer.msg(json["msg"], {icon: 6});
                            $("#userTable").bootstrapTable("remove",{field: 'uId',values: [uId]});//注意参数的name
                        }else{
                            layer.msg(json["msg"], {icon: 5});
                        }
                    },
                    error: function (data) {
                        layer.msg("未知错误！", {icon: 5});
                    }

                })
            }
        })
    }
    //表格渲染
    $(function () {
        $("#userTable").bootstrapTable({//在id为dataTable的
            url: '/user/list',
            pagination: true,//是否分页
            toolbar: "#toolbar",
            toolbarAlign: "right",
            //search: true,//是否允许搜索
            queryParamsType: 'limit',
            queryParams: queryParams,
            sidePagination: 'server',
            dataField: "data",
            columns: [{//表头
                field: 'uId',
                title: 'ID'
            }, {
                field: 'uname',
                title: '登录名'
            }, {
                field: 'roleId',
                title: '权限',
                formatter: function (value) {
                    if (value == 1) {
                        return '管理员';
                    } else {
                        return '普通用户';
                    }
                }

            },{
                title: '操作',
                formatter: function (value,row) {
                    return ['<button type="button" class="btn btn-danger btn-xs" ',
                        'onClick=removeUser(' + row.uId + ')>',
                        '<i class="fa fa-remove" >删除</i></button>']
                        .join('');
                }
            }
            ]
        })
    });


    function queryParams(params) {
        return {
            //把我们的pageNum，pageSize传到命令中去
            pageSize: params.limit,
            pageNum: params.offset / params.limit + 1,
            keyword: $("#keyword").val()
        }
    }
</script>

<script>
    //用户添加
    $("#userAdd").validate({
        rules: {
            uname: {
                required: true,//用户名是必填字段
                minlength: 4,//4位
                maxlength: 20,//最多输入20
                remote: {
                    url: "/user/check-username",
                    type: "get",
                    data: {
                        uname: function () {
                            return $("#uname").val();
                        }
                    }
                }
            },
            password: {
                required: true,
            },
            repassword: {
                required: true,
                equalTo: '#password',
            },
        },
        messages: {
            //定义消息
            uname: {
                required: "请输入用户名!",
                remote: "用户名已存在，请修改用户名！"
            },
            password: {
                required: "请输入密码!"
            },
            repassword: {
                required: "请确认密码！",
                equalTo: "两次密码输入不一致"
            },
        },
        submitHandler: function (form) {
            var uname = $("#uname").val();
            var password = $(":password:eq(0)").val();
            //验证完成后提交表单
            //进行ajax传值
            $.ajax({
                type: "POST",
                contentType: "application/json",
                url: basePath + "/user/save",
                data: JSON.stringify({"uname": uname, "password": password}),
                dataType: "json",
                success: function (msg) {
                    var json = msg["data"];
                    if (json["success"]) {
                        $("#userAdd")[0].reset();
                        layer.msg(json["msg"], {icon: 6, shade: 0.4}, function () {

                        });
                        $("#userTable").bootstrapTable("refresh");

                    } else {
                        layer.msg(json["msg"], {icon: 5});
                    }
                }
            });

        }
    });
</script>

</body>
</html>